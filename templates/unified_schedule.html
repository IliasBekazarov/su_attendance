{% extends 'base.html' %}
{% load static %}
{% load i18n %}

{% block title %}üìÖ Unified Schedule - –†–∞—Å–ø–∏—Å–∞–Ω–∏–µ{% endblock %}

{% block extra_css %}
<style>
    /* === –ë–ê–ó–ê–õ–´–ö –°–¢–ò–õ–î–ï–† === */
    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
    }

    .unified-schedule-container {
        max-width: 1400px;
        margin: 0 auto;
        padding: 20px;
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
    }

    /* === –ó–ê–ì–û–õ–û–í–û–ö === */
    .schedule-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 30px;
        border-radius: 12px;
        margin-bottom: 30px;
        text-align: center;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
    }

    .schedule-header h1 {
        font-size: 2.2rem;
        font-weight: 700;
        margin-bottom: 10px;
    }

    .schedule-subtitle {
        font-size: 1.1rem;
        opacity: 0.9;
        font-weight: 400;
    }

    .user-role-badge {
        display: inline-block;
        background: rgba(255, 255, 255, 0.2);
        padding: 8px 16px;
        border-radius: 20px;
        margin-top: 10px;
        font-size: 0.9rem;
        font-weight: 500;
    }

    /* === –§–ò–õ–¨–¢–†–õ–ï–† === */
    .filters-section {
        background: white;
        padding: 25px;
        border-radius: 12px;
        margin-bottom: 30px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        border: 1px solid #e2e8f0;
    }

    .filters-title {
        color: #2d3748;
        font-size: 1.4rem;
        font-weight: 600;
        margin-bottom: 20px;
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .filter-step {
        margin-bottom: 25px;
    }

    .filter-label {
        color: #4a5568;
        font-size: 1rem;
        font-weight: 600;
        margin-bottom: 10px;
        display: block;
    }

    .course-buttons, .group-buttons {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
    }

    .course-btn, .group-btn {
        background: #f7fafc;
        color: #2d3748;
        border: 2px solid #e2e8f0;
        padding: 12px 20px;
        border-radius: 8px;
        cursor: pointer;
        font-size: 0.9rem;
        font-weight: 500;
        transition: all 0.3s ease;
        text-decoration: none;
        display: inline-block;
    }

    .course-btn:hover, .group-btn:hover {
        border-color: #667eea;
        background: #edf2f7;
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(102, 126, 234, 0.15);
    }

    .course-btn.active, .group-btn.active {
        background: #667eea;
        color: white;
        border-color: #667eea;
    }

    .group-section {
        display: none;
    }

    /* === –†–ê–°–ü–ò–°–ê–ù–ò–ï –¢–ê–ë–õ–ò–¶–ê–°–´ === */
    .schedule-section {
        background: white;
        border-radius: 12px;
        padding: 25px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        border: 1px solid #e2e8f0;
        margin-bottom: 30px;
    }

    .schedule-title {
        color: #2d3748;
        font-size: 1.4rem;
        font-weight: 600;
        margin-bottom: 20px;
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .schedule-grid {
        display: grid;
        grid-template-columns: 120px repeat(7, 1fr);
        gap: 1px;
        background: #e2e8f0;
        border-radius: 8px;
        overflow: hidden;
        min-width: 800px;
    }

    .schedule-cell {
        background: white;
        padding: 12px 8px;
        text-align: center;
        min-height: 70px;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-direction: column;
        position: relative;
        transition: all 0.2s ease;
    }

    .header-cell {
        background: #667eea;
        color: white;
        font-weight: 700;
        font-size: 0.9rem;
    }

    .time-cell {
        background: #f8fafc;
        font-weight: 700;
        color: #2d3748;
        font-size: 0.75rem;
        line-height: 1.2;
    }

    .lesson-cell {
        font-size: 0.8rem;
        padding: 8px 6px;
        background: #f7fafc;
        border-left: 3px solid #667eea;
        cursor: pointer;
        position: relative;
    }

    .lesson-cell:hover {
        background: #edf2f7;
        transform: scale(1.02);
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    .lesson-title {
        font-weight: 700;
        color: #2d3748;
        margin-bottom: 4px;
        line-height: 1.1;
    }

    .lesson-teacher {
        font-size: 0.7rem;
        color: #667eea;
        font-weight: 500;
        margin-bottom: 3px;
    }

    .lesson-room {
        font-size: 0.65rem;
        color: #718096;
        background: #e2e8f0;
        padding: 2px 6px;
        border-radius: 4px;
        display: inline-block;
    }

    .empty-cell {
        background: #f8fafc;
        color: #a0aec0;
        font-style: italic;
        cursor: pointer;
        border: 2px dashed #cbd5e0;
        font-size: 0.8rem;
    }

    .empty-cell:hover {
        background: #edf2f7;
        border-color: #667eea;
        color: #667eea;
    }

    /* === –ò–ù–¢–ï–†–ê–ö–¢–ò–í–î“Æ“Æ –ë–ê–°–ö–´–ß–¢–ê–† === */
    .action-btn {
        position: absolute;
        border: none;
        width: 20px;
        height: 20px;
        border-radius: 50%;
        cursor: pointer;
        opacity: 0;
        transition: all 0.3s ease;
        font-size: 11px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: bold;
    }

    .lesson-cell:hover .action-btn,
    .empty-cell:hover .action-btn {
        opacity: 1;
    }

    .add-btn {
        top: 4px;
        right: 4px;
        background: #48bb78;
    }

    .edit-btn {
        top: 4px;
        right: 4px;
        background: #ed8936;
    }

    .attendance-btn {
        bottom: 4px;
        left: 4px;
        background: #667eea;
    }

    .delete-btn {
        top: 4px;
        left: 4px;
        background: #f56565;
    }

    .add-btn:hover { background: #38a169; }
    .edit-btn:hover { background: #dd6b20; }
    .attendance-btn:hover { background: #5a67d8; }
    .delete-btn:hover { background: #e53e3e; }

    /* === –ú–û–î–ê–õ–î–ê–† === */
    .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.6);
        backdrop-filter: blur(5px);
    }

    .modal-content {
        background: white;
        margin: 5% auto;
        padding: 25px;
        border-radius: 12px;
        width: 90%;
        max-width: 500px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        animation: modalSlideIn 0.3s ease-out;
    }

    @keyframes modalSlideIn {
        from {
            opacity: 0;
            transform: translateY(-50px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        padding-bottom: 15px;
        border-bottom: 2px solid #e2e8f0;
    }

    .modal-title {
        font-size: 1.3rem;
        font-weight: 700;
        color: #2d3748;
    }

    .close-btn {
        color: #a0aec0;
        font-size: 24px;
        font-weight: bold;
        cursor: pointer;
        border: none;
        background: none;
        transition: color 0.3s ease;
        padding: 5px;
    }

    .close-btn:hover {
        color: #2d3748;
    }

    .form-group {
        margin-bottom: 20px;
    }

    .form-label {
        display: block;
        margin-bottom: 8px;
        font-weight: 600;
        color: #2d3748;
        font-size: 0.9rem;
    }

    .form-input, .form-select {
        width: 100%;
        padding: 12px;
        border: 2px solid #e2e8f0;
        border-radius: 8px;
        font-size: 0.9rem;
        transition: border-color 0.3s ease, box-shadow 0.3s ease;
    }

    .form-input:focus, .form-select:focus {
        outline: none;
        border-color: #667eea;
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }

    .modal-buttons {
        display: flex;
        gap: 10px;
        justify-content: flex-end;
        margin-top: 25px;
    }

    .modal-btn {
        padding: 12px 20px;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-size: 0.9rem;
        font-weight: 600;
        transition: all 0.3s ease;
    }

    .btn-primary {
        background: #667eea;
        color: white;
    }

    .btn-primary:hover {
        background: #5a67d8;
        transform: translateY(-2px);
    }

    .btn-danger {
        background: #f56565;
        color: white;
    }

    .btn-danger:hover {
        background: #e53e3e;
        transform: translateY(-2px);
    }

    .btn-secondary {
        background: #e2e8f0;
        color: #4a5568;
    }

    .btn-secondary:hover {
        background: #cbd5e0;
    }

    /* === ATTENDANCE MODAL === */
    .attendance-modal-content {
        max-width: 700px;
        max-height: 85vh;
        overflow-y: auto;
    }

    .lesson-info {
        background: #f7fafc;
        padding: 15px;
        border-radius: 8px;
        margin-bottom: 20px;
        border-left: 4px solid #667eea;
    }

    .lesson-info h3 {
        color: #2d3748;
        margin-bottom: 10px;
        font-size: 1.1rem;
    }

    .lesson-info p {
        margin: 6px 0;
        color: #4a5568;
        font-size: 0.9rem;
    }

    .students-list {
        max-height: 400px;
        overflow-y: auto;
    }

    .student-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 15px;
        background: #f8fafc;
        margin-bottom: 10px;
        border-radius: 8px;
        border: 1px solid #e2e8f0;
        transition: all 0.2s ease;
    }

    .student-item:hover {
        background: #edf2f7;
        border-color: #cbd5e0;
    }

    .student-name {
        font-weight: 600;
        color: #2d3748;
        flex: 1;
        font-size: 0.9rem;
    }

    .attendance-buttons {
        display: flex;
        gap: 8px;
    }

    .status-btn {
        padding: 8px 12px;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-size: 0.8rem;
        font-weight: 600;
        transition: all 0.3s ease;
        border: 2px solid transparent;
    }

    .status-btn.present {
        background: #48bb78;
        color: white;
    }

    .status-btn.present.active {
        background: #38a169;
        border-color: #2f855a;
        box-shadow: 0 0 0 2px rgba(72, 187, 120, 0.2);
    }

    .status-btn.late {
        background: #ed8936;
        color: white;
    }

    .status-btn.late.active {
        background: #dd6b20;
        border-color: #c05621;
        box-shadow: 0 0 0 2px rgba(237, 137, 54, 0.2);
    }

    .status-btn.absent {
        background: #f56565;
        color: white;
    }

    .status-btn.absent.active {
        background: #e53e3e;
        border-color: #c53030;
        box-shadow: 0 0 0 2px rgba(245, 101, 101, 0.2);
    }

    .attendance-summary {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 15px;
        margin: 20px 0;
        padding: 20px;
        background: #f7fafc;
        border-radius: 8px;
    }

    .summary-item {
        text-align: center;
        padding: 15px;
        background: white;
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
    }

    .summary-number {
        font-size: 2rem;
        font-weight: 800;
        margin-bottom: 5px;
    }

    .summary-label {
        font-size: 0.8rem;
        color: #4a5568;
        font-weight: 600;
    }

    .summary-present .summary-number { color: #48bb78; }
    .summary-late .summary-number { color: #ed8936; }
    .summary-absent .summary-number { color: #f56565; }

    /* === LOADING STATES === */
    .loading {
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 40px;
        color: #667eea;
        font-size: 1.1rem;
    }

    .spinner {
        border: 3px solid #e2e8f0;
        border-top: 3px solid #667eea;
        border-radius: 50%;
        width: 30px;
        height: 30px;
        animation: spin 1s linear infinite;
        margin-right: 10px;
    }

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    /* === SUCCESS/ERROR MESSAGES === */
    .alert {
        padding: 15px 20px;
        border-radius: 8px;
        margin-bottom: 20px;
        font-weight: 500;
        position: relative;
    }

    .alert-success {
        background: #c6f6d5;
        color: #22543d;
        border-left: 4px solid #48bb78;
    }

    .alert-error {
        background: #fed7d7;
        color: #742a2a;
        border-left: 4px solid #f56565;
    }

    /* === –ê–î–ê–ü–¢–ò–í–î“Æ“Æ –î–ò–ó–ê–ô–ù === */
    @media (max-width: 768px) {
        .unified-schedule-container {
            padding: 10px;
        }
        
        .schedule-header {
            padding: 20px 15px;
        }
        
        .schedule-header h1 {
            font-size: 1.8rem;
        }
        
        .filters-section, .schedule-section {
            padding: 15px;
        }
        
        .course-buttons, .group-buttons {
            justify-content: center;
        }
        
        .schedule-grid {
            grid-template-columns: 100px repeat(7, 1fr);
            min-width: 600px;
        }
        
        .schedule-cell {
            min-height: 60px;
            padding: 8px 4px;
            font-size: 0.7rem;
        }
        
        .modal-content {
            width: 95%;
            margin: 10% auto;
            padding: 20px;
        }
        
        .attendance-summary {
            grid-template-columns: 1fr;
        }
    }

    .hidden {
        display: none !important;
    }

    .fade-in {
        animation: fadeIn 0.5s ease-out;
    }

    @keyframes fadeIn {
        from {
            opacity: 0;
            transform: translateY(10px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="unified-schedule-container">
    <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ -->
    <div class="schedule-header">
        <h1>üéì Unified Schedule System</h1>
        <div class="schedule-subtitle">–ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–¥“Ø“Ø —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ –±–∞—à–∫–∞—Ä—É—É —Å–∏—Å—Ç–µ–º–∞—Å—ã</div>
        <div class="user-role-badge">
            {{ user_profile.get_role_display }} - {{ user.get_full_name|default:user.username }}
        </div>
    </div>

    <!-- –§–∏–ª—å—Ç—Ä–ª–µ—Ä -->
    <div class="filters-section">
        <h2 class="filters-title">üîç –§–∏–ª—å—Ç—Ä–ª–µ—Ä</h2>
        
        {% if not is_restricted_view %}
        <!-- –ö—É—Ä—Å —Ç–∞–Ω–¥–æ–æ (–ê–¥–º–∏–Ω/–ú–µ–Ω–µ–¥–∂–µ—Ä/–ú—É–≥–∞–ª–∏–º “Ø—á“Ø–Ω) -->
        <div class="filter-step">
            <label class="filter-label">1Ô∏è‚É£ –ö—É—Ä—Å—Ç—É —Ç–∞–Ω–¥–∞“£—ã–∑:</label>
            <div class="course-buttons" id="courseButtons">
                {% for course in courses %}
                <button class="course-btn" data-course-id="{{ course.id }}" onclick="selectCourse({{ course.id }})">
                    üìö {{ course.name }} ({{ course.year }}-–∫—É—Ä—Å)
                </button>
                {% endfor %}
            </div>
        </div>

        <!-- –ì—Ä—É–ø–ø–∞ —Ç–∞–Ω–¥–æ–æ -->
        <div class="filter-step group-section" id="groupSection">
            <label class="filter-label">2Ô∏è‚É£ –ì—Ä—É–ø–ø–∞–Ω—ã —Ç–∞–Ω–¥–∞“£—ã–∑:</label>
            <div class="group-buttons" id="groupButtons">
                <!-- AJAX –∞—Ä–∫—ã–ª—É—É –∂“Ø–∫—Ç”©–ª”©—Ç -->
            </div>
        </div>
        {% else %}
        <!-- –ß–µ–∫—Ç–µ–ª–≥–µ–Ω –∫”©—Ä“Ø“Ø (–°—Ç—É–¥–µ–Ω—Ç/–ê—Ç–∞-—ç–Ω–µ) -->
        <div class="alert alert-info">
            <strong>‚ÑπÔ∏è –ú–∞–∞–ª—ã–º–∞—Ç:</strong> 
            {% if user_role == 'STUDENT' %}
                –°–∏–∑ ”©–∑“Ø“£“Ø–∑–¥“Ø–Ω –≥—Ä—É–ø–ø–∞“£—ã–∑–¥—ã–Ω —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ—Å–∏–Ω –≥–∞–Ω–∞ –∫”©—Ä”© –∞–ª–∞—Å—ã–∑.
                {% if user_group %}
                    <br><strong>–°–∏–∑–¥–∏–Ω –≥—Ä—É–ø–ø–∞:</strong> {{ user_group.name }} ({{ user_course.name }})
                {% endif %}
            {% elif user_role == 'PARENT' %}
                –°–∏–∑ ”©–∑“Ø“£“Ø–∑–¥“Ø–Ω –±–∞–ª–¥–∞—Ä—ã“£—ã–∑–¥—ã–Ω –≥—Ä—É–ø–ø–∞–ª–∞—Ä—ã–Ω—ã–Ω —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ—Å–∏–Ω –∫”©—Ä”© –∞–ª–∞—Å—ã–∑.
            {% endif %}
        </div>
        {% endif %}
    </div>

    <!-- –†–∞—Å–ø–∏—Å–∞–Ω–∏–µ —Ç–∞–±–ª–∏—Ü–∞—Å—ã -->
    <div class="schedule-section" id="scheduleSection" style="display: none;">
        <h2 class="schedule-title" id="scheduleTitle">üìÖ –†–∞—Å–ø–∏—Å–∞–Ω–∏–µ</h2>
        
        <div id="scheduleContent">
            <div class="loading" id="loadingIndicator">
                <div class="spinner"></div>
                –ú–∞–∞–ª—ã–º–∞—Ç—Ç–∞—Ä –∂“Ø–∫—Ç”©–ª“Ø“Ø–¥”©...
            </div>
            
            <!-- Debug –º–∞–∞–ª—ã–º–∞—Ç—ã -->
            <div id="debugInfo" style="background: #f0f0f0; padding: 10px; margin: 10px 0; border-radius: 5px; font-family: monospace; font-size: 12px;">
                Debug: Waiting for data...
            </div>
            
            <!-- Test —Ç–∞–±–ª–∏—Ü–∞ -->
            <div id="testSchedule" style="display: none;">
                <h3>Test Schedule Table</h3>
                <table border="1" style="width: 100%; border-collapse: collapse;">
                    <tr>
                        <th>–£–±–∞–∫—ã—Ç</th>
                        <th>–î“Ø–π—à”©–º–±“Ø</th>
                        <th>–®–µ–π—à–µ–º–±–∏</th>
                        <th>–®–∞—Ä—à–µ–º–±–∏</th>
                    </tr>
                    <tr>
                        <td>09:00-09:50</td>
                        <td>–ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞</td>
                        <td>–§–∏–∑–∏–∫–∞</td>
                        <td>–•–∏–º–∏—è</td>
                    </tr>
                    <tr>
                        <td>10:00-10:50</td>
                        <td>Python</td>
                        <td>Web</td>
                        <td>Database</td>
                    </tr>
                </table>
                <button onclick="document.getElementById('testSchedule').style.display='none'">–ñ–∞—à—ã—Ä—É—É</button>
            </div>
            
            <button onclick="document.getElementById('testSchedule').style.display='block'" style="margin: 10px;">Test —Ç–∞–±–ª–∏—Ü–∞ –∫”©—Ä—Å”©—Ç“Ø“Ø</button>
        </div>
    </div>
</div>

<!-- –°–∞–±–∞–∫ –∫–æ—à—É—É/—Ç“Ø–∑”©—Ç“Ø“Ø –º–æ–¥–∞–ª—ã -->
<div id="lessonModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 class="modal-title" id="lessonModalTitle">üìö –°–∞–±–∞–∫ –∫–æ—à—É—É</h3>
            <button class="close-btn" onclick="closeLessonModal()">&times;</button>
        </div>
        <form id="lessonForm">
            <div class="form-group">
                <label class="form-label" for="subjectSelect">üìö –°–∞–±–∞–∫:</label>
                <select id="subjectSelect" class="form-select" required>
                    <option value="">–°–∞–±–∞–∫—Ç—ã —Ç–∞–Ω–¥–∞“£—ã–∑...</option>
                    {% for subject in subjects %}
                    <option value="{{ subject.id }}">{{ subject.subject_name }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="form-group">
                <label class="form-label" for="teacherSelect">üë®‚Äçüè´ –ú—É–≥–∞–ª–∏–º:</label>
                <select id="teacherSelect" class="form-select">
                    <option value="">–ú—É–≥–∞–ª–∏–º–¥–∏ —Ç–∞–Ω–¥–∞“£—ã–∑...</option>
                    {% for teacher in teachers %}
                    <option value="{{ teacher.id }}">{{ teacher.name }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="form-group">
                <label class="form-label" for="roomInput">üìç –ö–∞–±–∏–Ω–µ—Ç:</label>
                <input type="text" id="roomInput" class="form-input" placeholder="304, Lab-1, –ê—É–¥-205...">
            </div>
            <div class="modal-buttons">
                <button type="button" class="modal-btn btn-secondary" onclick="closeLessonModal()">‚ùå –ñ–æ–∫–∫–æ —á—ã–≥–∞—Ä—É—É</button>
                <button type="button" class="modal-btn btn-danger" id="deleteLessonBtn" onclick="deleteLesson()" style="display: none;">üóëÔ∏è ”®—á“Ø—Ä“Ø“Ø</button>
                <button type="submit" class="modal-btn btn-primary">üíæ –°–∞–∫—Ç–æ–æ</button>
            </div>
        </form>
    </div>
</div>

<!-- –ö–µ–ª“Ø“Ø-–∫–µ—Ç“Ø“Ø –±–µ–ª–≥–∏–ª”©”© –º–æ–¥–∞–ª—ã -->
<div id="attendanceModal" class="modal">
    <div class="modal-content attendance-modal-content">
        <div class="modal-header">
            <h3 class="modal-title">üìã –ö–µ–ª“Ø“Ø-–∫–µ—Ç“Ø“Ø –±–µ–ª–≥–∏–ª”©”©</h3>
            <button class="close-btn" onclick="closeAttendanceModal()">&times;</button>
        </div>
        
        <div id="lessonInfo" class="lesson-info">
            <!-- –°–∞–±–∞–∫ –º–∞–∞–ª—ã–º–∞—Ç—ã AJAX –∞—Ä–∫—ã–ª—É—É –∂“Ø–∫—Ç”©–ª”©—Ç -->
        </div>
        
        <div class="students-list" id="studentsList">
            <!-- –°—Ç—É–¥–µ–Ω—Ç—Ç–µ—Ä —Ç–∏–∑–º–µ—Å–∏ AJAX –∞—Ä–∫—ã–ª—É—É –∂“Ø–∫—Ç”©–ª”©—Ç -->
        </div>
        
        <div class="attendance-summary" id="attendanceSummary">
            <div class="summary-item summary-present">
                <div class="summary-number" id="presentCount">0</div>
                <div class="summary-label">‚úÖ –ö–µ–ª–¥–∏</div>
            </div>
            <div class="summary-item summary-late">
                <div class="summary-number" id="lateCount">0</div>
                <div class="summary-label">‚è∞ –ö–µ—á–∏–∫—Ç–∏</div>
            </div>
            <div class="summary-item summary-absent">
                <div class="summary-number" id="absentCount">0</div>
                <div class="summary-label">‚ùå –ñ–æ–∫</div>
            </div>
        </div>
        
        <div class="modal-buttons">
            <button type="button" class="modal-btn btn-secondary" onclick="closeAttendanceModal()">‚ùå –ñ–∞–±—É—É</button>
            <button type="button" class="modal-btn btn-primary" onclick="saveAttendance()">üíæ –°–∞–∫—Ç–æ–æ</button>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// === –ì–õ–û–ë–ê–õ–î–´–ö ”®–ó–ì”®–†–ú”®–õ”®–† ===
let currentCourseId = null;
let currentGroupId = null;
let currentLessonId = null;
let currentAttendanceData = {};
let scheduleData = {};
let timeSlots = [];
let userPermissions = {};

// === –ë–ê–®–¢–ê–õ–£–£ ===
document.addEventListener('DOMContentLoaded', function() {
    console.log('DOM loaded. User role: {{ user_role }}, Is restricted: {{ is_restricted_view }}');
    
    {% if is_restricted_view %}
        {% if user_role == 'STUDENT' and user_group %}
            console.log('Loading schedule for student group: {{ user_group.id }}');
            // –°—Ç—É–¥–µ–Ω—Ç “Ø—á“Ø–Ω —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ –±”©–ª“Ø–º“Ø–Ω –∫”©—Ä—Å”©—Ç“Ø–ø, –¥–∞—Ä–æ–æ –∂“Ø–∫—Ç”©”©–ª“Ø
            const scheduleSection = document.getElementById('scheduleSection');
            if (scheduleSection) {
                scheduleSection.style.display = 'block';
            }
            // –°—Ç—É–¥–µ–Ω—Ç “Ø—á“Ø–Ω ”©–∑“Ø–Ω“Ø–Ω –≥—Ä—É–ø–ø–∞—Å—ã–Ω –∫”©—Ä—Å”©—Ç“Ø“Ø
            loadScheduleForGroup({{ user_group.id }});
        {% elif user_role == 'PARENT' %}
            console.log('Parent view not implemented yet');
            // –ê—Ç–∞-—ç–Ω–µ “Ø—á“Ø–Ω –±–∞–ª–¥–∞—Ä—ã–Ω—ã–Ω –≥—Ä—É–ø–ø–∞–ª–∞—Ä—ã–Ω –∫”©—Ä—Å”©—Ç“Ø“Ø
            // TODO: Implement parent view
        {% endif %}
    {% else %}
        console.log('Full access mode for admin/manager/teacher');
    {% endif %}
});

// === –ö–£–†–° –¢–ê–ù–î–û–û ===
function selectCourse(courseId) {
    currentCourseId = courseId;
    
    // –≠–≥–µ—Ä–¥–µ –º—É—Ä—É–Ω–∫—É –≥—Ä—É–ø–ø–∞ —Ç–∞–Ω–¥–∞–ª–≥–∞–Ω –±–æ–ª—Å–æ, –∞–Ω—ã —Å–∞–∫—Ç–∞–ø –∫–∞–ª–∞–±—ã–∑
    const previousGroupId = currentGroupId;
    
    // –ê–∫—Ç–∏–≤–¥“Ø“Ø –∫—É—Ä—Å –±–∞—Å–∫—ã—á—ã–Ω –±–µ–ª–≥–∏–ª”©”©
    document.querySelectorAll('.course-btn').forEach(btn => {
        btn.classList.remove('active');
    });
    document.querySelector(`[data-course-id="${courseId}"]`).classList.add('active');
    
    // –ú—É—Ä—É–Ω–∫—É –≥—Ä—É–ø–ø–∞ –∞–∫—Ç–∏–≤–∞—Ü–∏–∏ –∞–ª—ã–ø —Å–∞–ª—É—É
    document.querySelectorAll('.group-btn').forEach(btn => {
        btn.classList.remove('active');
    });
    
    // –†–∞—Å–ø–∏—Å–∞–Ω–∏–µ –±”©–ª“Ø–º“Ø–Ω –∂–∞—à—ã—Ä—É—É (–∂–∞“£—ã –≥—Ä—É–ø–ø–∞ —Ç–∞–Ω–¥–∞–ª–º–∞–π—ã–Ω—á–∞)
    const scheduleSection = document.getElementById('scheduleSection');
    if (scheduleSection) {
        scheduleSection.style.display = 'none';
    }
    
    // currentGroupId'–Ω–∏ –∞–Ω—ã–∫—Å—ã–∑ –∫—ã–ª—É—É
    currentGroupId = null;
    
    // –ß–µ–∫—Ç–µ–ª–≥–µ–Ω –∫”©—Ä“Ø“Ø “Ø—á“Ø–Ω (—Å—Ç—É–¥–µ–Ω—Ç) –≥—Ä—É–ø–ø–∞–ª–∞—Ä–¥—ã –∂“Ø–∫—Ç”©–±”©–π–±“Ø–∑
    const isRestrictedView = {% if is_restricted_view %}true{% else %}false{% endif %};
    
    if (!isRestrictedView) {
        // –ì—Ä—É–ø–ø–∞–ª–∞—Ä–¥—ã –∂“Ø–∫—Ç”©”©
        loadGroupsForCourse(courseId, previousGroupId);
    }
}

// === –ì–†–£–ü–ü–ê–õ–ê–†–î–´ –ñ“Æ–ö–¢”®”® ===
function loadGroupsForCourse(courseId, autoSelectGroupId = null) {
    console.log(`loadGroupsForCourse called: courseId=${courseId}, autoSelectGroupId=${autoSelectGroupId}`);
    
    // –≠–≥–µ—Ä–¥–µ —á–µ–∫—Ç–µ–ª–≥–µ–Ω –∫”©—Ä“Ø“Ø –±–æ–ª—Å–æ (—Å—Ç—É–¥–µ–Ω—Ç), –≥—Ä—É–ø–ø–∞–ª–∞—Ä —Å–µ–∫—Ü–∏—è—Å—ã –∂–æ–∫ –±–æ–ª–æ—Ç
    const isRestrictedView = {% if is_restricted_view %}true{% else %}false{% endif %};
    
    if (isRestrictedView) {
        console.log('Restricted view - skipping group loading');
        return;
    }
    
    fetch(`{% url 'get_groups_for_course' %}?course_id=${courseId}`)
        .then(response => {
            console.log(`API response status: ${response.status}`);
            return response.json();
        })
        .then(data => {
            console.log('API response data:', data);
            
            if (data.groups) {
                displayGroups(data.groups);
                
                // groupSection —ç–ª–µ–º–µ–Ω—Ç–∏–Ω —Ç–µ–∫—à–µ—Ä“Ø“Ø
                const groupSection = document.getElementById('groupSection');
                if (groupSection) {
                    groupSection.style.display = 'block';
                } else {
                    console.warn('groupSection element not found');
                }
                
                // –ê–≤—Ç–æ–º–∞—Ç—Ç—ã–∫ –≥—Ä—É–ø–ø–∞ —Ç–∞–Ω–¥–æ–æ –ª–æ–≥–∏–∫–∞—Å—ã
                if (autoSelectGroupId) {
                    // –ú—É—Ä—É–Ω–∫—É –≥—Ä—É–ø–ø–∞–Ω—ã —Ç–∞–±—É—É–≥–∞ –∞—Ä–∞–∫–µ—Ç
                    const groupExists = data.groups.find(g => g.id == autoSelectGroupId);
                    if (groupExists) {
                        console.log(`Auto-selecting existing group: ${autoSelectGroupId}`);
                        selectGroup(autoSelectGroupId);
                        return;
                    }
                }
                
                // –≠–≥–µ—Ä–¥–µ –º—É—Ä—É–Ω–∫—É –≥—Ä—É–ø–ø–∞ –∂–æ–∫ –±–æ–ª—Å–æ –∂–µ –±–∏—Ä–∏–Ω—á–∏ –∂–æ–ª—É —Ç–∞–Ω–¥–∞–ª—Å–∞, –±–∏—Ä–∏–Ω—á–∏ –≥—Ä—É–ø–ø–∞–Ω—ã —Ç–∞–Ω–¥–æ–æ
                if (data.groups.length > 0) {
                    console.log(`Auto-selecting first group: ${data.groups[0].id}`);
                    selectGroup(data.groups[0].id);
                }
            } else {
                console.error('No groups in API response');
                showError('–ì—Ä—É–ø–ø–∞–ª–∞—Ä –∂“Ø–∫—Ç”©–ª–≥”©–Ω –∂–æ–∫');
            }
        })
        .catch(error => {
            console.error('Error loading groups:', error);
            showError('–ì—Ä—É–ø–ø–∞–ª–∞—Ä–¥—ã –∂“Ø–∫—Ç”©”©–¥”© –∫–∞—Ç–∞ –∫–µ—Ç—Ç–∏: ' + error.message);
        });
}

// === –ì–†–£–ü–ü–ê–õ–ê–†–î–´ –ö”®–†–°”®–¢“Æ“Æ ===
function displayGroups(groups) {
    console.log('displayGroups called with:', groups); // Debug –ª–æ–≥—É
    
    const groupButtons = document.getElementById('groupButtons');
    if (!groupButtons) {
        console.error('groupButtons element not found - this is normal for restricted view (students)');
        return;
    }
    
    groupButtons.innerHTML = '';
    
    groups.forEach(group => {
        const button = document.createElement('button');
        button.className = 'group-btn';
        button.setAttribute('data-group-id', group.id);
        button.onclick = () => selectGroup(group.id);
        
        const studentCount = group.student_count !== undefined ? group.student_count : 0;
        button.innerHTML = `üë• ${group.name} <small>(${studentCount} —Å—Ç—É–¥–µ–Ω—Ç)</small>`;
        groupButtons.appendChild(button);
    });
    
    console.log(`displayGroups: Added ${groups.length} group buttons`); // Debug –ª–æ–≥—É
}

// === –ì–†–£–ü–ü–ê –¢–ê–ù–î–û–û ===
function selectGroup(groupId) {
    currentGroupId = groupId;
    
    // –ê–∫—Ç–∏–≤–¥“Ø“Ø –≥—Ä—É–ø–ø–∞ –±–∞—Å–∫—ã—á—ã–Ω –±–µ–ª–≥–∏–ª”©”©
    document.querySelectorAll('.group-btn').forEach(btn => {
        btn.classList.remove('active');
    });
    document.querySelector(`[data-group-id="${groupId}"]`).classList.add('active');
    
    // –†–∞—Å–ø–∏—Å–∞–Ω–∏–µ –±”©–ª“Ø–º“Ø–Ω –∫”©—Ä—Å”©—Ç“Ø“Ø
    const scheduleSection = document.getElementById('scheduleSection');
    if (scheduleSection) {
        scheduleSection.style.display = 'block';
    } else {
        console.log('scheduleSection element not found - this is normal for restricted view');
    }
    
    // –†–∞—Å–ø–∏—Å–∞–Ω–∏–µ–Ω–∏ –∂“Ø–∫—Ç”©”©
    loadScheduleForGroup(groupId);
}

// === –†–ê–°–ü–ò–°–ê–ù–ò–ï–ù–ò –ñ“Æ–ö–¢”®”® ===
function loadScheduleForGroup(groupId) {
    console.log(`loadScheduleForGroup called: groupId=${groupId}, currentCourseId=${currentCourseId}`);
    
    const loadingIndicator = document.getElementById('loadingIndicator');
    const scheduleContent = document.getElementById('scheduleContent');
    
    if (loadingIndicator) {
        loadingIndicator.style.display = 'flex';
    }
    
    let url = `{% url 'get_schedule_data' %}?group_id=${groupId}`;
    if (currentCourseId) {
        url += `&course_id=${currentCourseId}`;
    }
    
    console.log(`API URL: ${url}`);
    
    fetch(url)
        .then(response => response.json())
        .then(data => {
            console.log('API Response:', data); // Debug –ª–æ–≥—É
            if (data.schedule_data) {
                scheduleData = data.schedule_data;
                timeSlots = data.time_slots;
                userPermissions = data.user_permissions;
                console.log('Schedule Data:', scheduleData); // Debug –ª–æ–≥—É
                console.log('Time Slots:', timeSlots); // Debug –ª–æ–≥—É
                displaySchedule(data);
                if (loadingIndicator) {
                    loadingIndicator.style.display = 'none';
                }
            } else {
                if (loadingIndicator) {
                    loadingIndicator.style.display = 'none';
                }
                console.error('No schedule_data in API response:', data);
                showError(data.error || '–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ –∂“Ø–∫—Ç”©–ª–≥”©–Ω –∂–æ–∫');
            }
        })
        .catch(error => {
            console.error('Error loading schedule:', error);
            if (loadingIndicator) {
                loadingIndicator.style.display = 'none';
            }
            showError('–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ–Ω–∏ –∂“Ø–∫—Ç”©”©–¥”© –∫–∞—Ç–∞ –∫–µ—Ç—Ç–∏: ' + error.message);
        });
}

// === –†–ê–°–ü–ò–°–ê–ù–ò–ï–ù–ò –ö”®–†–°”®–¢“Æ“Æ ===
function displaySchedule(data) {
    console.log('displaySchedule called with:', data); // Debug
    
    const scheduleContent = document.getElementById('scheduleContent');
    const debugInfo = document.getElementById('debugInfo');
    
    // scheduleContent —ç–ª–µ–º–µ–Ω—Ç–∏–Ω —Ç–µ–∫—à–µ—Ä“Ø“Ø
    if (!scheduleContent) {
        console.error('scheduleContent element not found');
        showError('–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ –±–ª–æ–≥—É —Ç–∞–±—ã–ª–≥–∞–Ω –∂–æ–∫');
        return;
    }
    
    // –î–∞–Ω–Ω—ã–µ–Ω—ã —Ç–µ–∫—à–µ—Ä“Ø“Ø
    if (!data) {
        console.error('Data is null or undefined');
        showError('–ú–∞–∞–ª—ã–º–∞—Ç –∫–µ–ª–≥–µ–Ω –∂–æ–∫');
        return;
    }
    
    if (!data.days) {
        console.error('Days data is missing');
        showError('–ö“Ø–Ω–¥”©—Ä –º–∞–∞–ª—ã–º–∞—Ç—ã –∂–æ–∫');
        return;
    }
    
    if (!timeSlots || timeSlots.length === 0) {
        console.error('Time slots are missing');
        showError('–£–±–∞–∫—ã—Ç —Å–ª–æ—Ç—Ç–æ—Ä—É –∂–æ–∫');
        return;
    }
    
    if (!scheduleData) {
        console.error('Schedule data is missing');
        scheduleData = {};
    }
    
    // Debug –º–∞–∞–ª—ã–º–∞—Ç—ã–Ω –∫”©—Ä—Å”©—Ç“Ø“Ø
    if (debugInfo) {
        debugInfo.innerHTML = `
            Debug:<br>
            - Days: ${data.days ? Object.keys(data.days).length : '–∂–æ–∫'}<br>
            - TimeSlots: ${data.time_slots ? data.time_slots.length : '–∂–æ–∫'}<br>
            - ScheduleData: ${data.schedule_data ? Object.keys(data.schedule_data).length : '–∂–æ–∫'}<br>
            - User Role: ${data.user_permissions ? data.user_permissions.role || '–∞–Ω—ã–∫—Ç–∞–ª–≥–∞–Ω –∂–æ–∫' : '–∂–æ–∫'}
        `;
    }
    
    const days = Object.keys(data.days);
    
    console.log('Days:', days); // Debug
    console.log('TimeSlots:', timeSlots); // Debug
    console.log('Available schedule data keys:', Object.keys(data.schedule_data || {})); // Debug
    
    let html = `
        <div class="schedule-grid">
            <div class="schedule-cell header-cell">‚è∞ –£–±–∞–∫—ã—Ç</div>
    `;
    
    // –ö“Ø–Ω–¥”©—Ä–¥“Ø –∫–æ—à—É—É
    days.forEach(dayKey => {
        html += `<div class="schedule-cell header-cell">${data.days[dayKey]}</div>`;
    });
    
    // –£–±–∞–∫—ã—Ç —Å–ª–æ—Ç—Ç–æ—Ä—É –∂–∞–Ω–∞ —Å–∞–±–∞–∫—Ç–∞—Ä
    timeSlots.forEach(timeSlot => {
        html += `
            <div class="schedule-cell time-cell">
                <strong>${timeSlot.name}</strong><br>
                <small>${timeSlot.start_time} - ${timeSlot.end_time}</small>
            </div>
        `;
        
        days.forEach(dayKey => {
            const lesson = scheduleData[dayKey] && scheduleData[dayKey][timeSlot.id];
            
            if (lesson) {
                html += `
                    <div class="schedule-cell lesson-cell" onclick="handleLessonClick(${lesson.id})">
                        ${userPermissions.can_edit ? `
                            <button class="action-btn edit-btn" onclick="event.stopPropagation(); editLesson(${lesson.id})" title="”®–∑–≥”©—Ä—Ç“Ø“Ø">‚úèÔ∏è</button>
                            <button class="action-btn delete-btn" onclick="event.stopPropagation(); confirmDeleteLesson(${lesson.id})" title="”®—á“Ø—Ä“Ø“Ø">üóëÔ∏è</button>
                        ` : ''}
                        ${userPermissions.can_mark_attendance && lesson.can_mark_attendance ? `
                            <button class="action-btn attendance-btn" onclick="event.stopPropagation(); openAttendanceModal(${lesson.id})" title="–ñ–æ–∫—Ç–æ–æ –±–µ–ª–≥–∏–ª”©”©">üìã</button>
                        ` : ''}
                        <div class="lesson-title">${lesson.subject}</div>
                        <div class="lesson-teacher">üë®‚Äçüè´ ${lesson.teacher}</div>
                        <div class="lesson-room">üìç ${lesson.room}</div>
                    </div>
                `;
            } else {
                html += `
                    <div class="schedule-cell empty-cell" onclick="handleEmptyClick('${timeSlot.id}', '${dayKey}')">
                        ${userPermissions.can_edit ? `
                            <button class="action-btn add-btn" onclick="event.stopPropagation(); addLesson('${timeSlot.id}', '${dayKey}')" title="–ö–æ—à—É—É">‚ûï</button>
                        ` : ''}
                        –≠—Ä–∫–∏–Ω —É–±–∞–∫—ã—Ç
                    </div>
                `;
            }
        });
    });
    
    html += '</div>';
    
    if (scheduleContent) {
        scheduleContent.innerHTML = html;
        scheduleContent.classList.add('fade-in');
    } else {
        console.error('scheduleContent element not found when trying to set innerHTML');
    }
}

// === –°–ê–ë–ê–ö –ö–û–®–£–£ ===
function addLesson(timeSlotId, day) {
    if (!userPermissions.can_edit) {
        showError('–°–∏–∑–¥–µ —Å–∞–±–∞–∫ –∫–æ—à—É—É —É–∫—É–≥—É –∂–æ–∫');
        return;
    }
    
    currentLessonId = null;
    document.getElementById('lessonModalTitle').textContent = 'üìö –ñ–∞“£—ã —Å–∞–±–∞–∫ –∫–æ—à—É—É';
    document.getElementById('subjectSelect').value = '';
    document.getElementById('teacherSelect').value = '';
    document.getElementById('roomInput').value = '';
    document.getElementById('deleteLessonBtn').style.display = 'none';
    
    // –ú–æ–¥–∞–ª–¥–∞ —É–±–∞–∫—ã—Ç –∂–∞–Ω–∞ –∫“Ø–Ω –º–∞–∞–ª—ã–º–∞—Ç—ã–Ω —Å–∞–∫—Ç–æ–æ
    document.getElementById('lessonForm').setAttribute('data-time-slot', timeSlotId);
    document.getElementById('lessonForm').setAttribute('data-day', day);
    
    document.getElementById('lessonModal').style.display = 'block';
}

// === –°–ê–ë–ê–ö–¢–´ ”®–ó–ì”®–†–¢“Æ“Æ ===
function editLesson(lessonId) {
    if (!userPermissions.can_edit) {
        showError('–°–∏–∑–¥–µ —Å–∞–±–∞–∫ ”©–∑–≥”©—Ä—Ç“Ø“Ø —É–∫—É–≥—É –∂–æ–∫');
        return;
    }
    
    // Lesson –º–∞–∞–ª—ã–º–∞—Ç—ã–Ω —Ç–∞–±—É—É
    let lesson = null;
    Object.values(scheduleData).forEach(daySchedule => {
        Object.values(daySchedule).forEach(timeSlotLesson => {
            if (timeSlotLesson.id === lessonId) {
                lesson = timeSlotLesson;
            }
        });
    });
    
    if (!lesson) {
        showError('–°–∞–±–∞–∫ —Ç–∞–±—ã–ª–≥–∞–Ω –∂–æ–∫');
        return;
    }
    
    currentLessonId = lessonId;
    document.getElementById('lessonModalTitle').textContent = '‚úèÔ∏è –°–∞–±–∞–∫—Ç—ã ”©–∑–≥”©—Ä—Ç“Ø“Ø';
    document.getElementById('subjectSelect').value = lesson.subject_id || '';
    document.getElementById('teacherSelect').value = lesson.teacher_id || '';
    document.getElementById('roomInput').value = lesson.room || '';
    document.getElementById('deleteLessonBtn').style.display = 'inline-block';
    
    document.getElementById('lessonModal').style.display = 'block';
}

// === –°–ê–ë–ê–ö–¢–´ ”®–ß“Æ–†“Æ“Æ ===
function confirmDeleteLesson(lessonId) {
    if (!userPermissions.can_edit) {
        showError('–°–∏–∑–¥–µ —Å–∞–±–∞–∫ ”©—á“Ø—Ä“Ø“Ø —É–∫—É–≥—É –∂–æ–∫');
        return;
    }
    
    if (confirm('–ë—É–ª —Å–∞–±–∞–∫—Ç—ã ”©—á“Ø—Ä”©—Å“Ø–∑–±“Ø?')) {
        deleteLesson(lessonId);
    }
}

function deleteLesson(lessonId = null) {
    const idToDelete = lessonId || currentLessonId;
    
    if (!idToDelete) {
        showError('”®—á“Ø—Ä“Ø“Ø “Ø—á“Ø–Ω —Å–∞–±–∞–∫ —Ç–∞–Ω–¥–∞–ª–≥–∞–Ω –∂–æ–∫');
        return;
    }
    
    fetch('{% url "delete_schedule_lesson" %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCSRFToken()
        },
        body: JSON.stringify({
            lesson_id: idToDelete
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showSuccess(data.message);
            closeLessonModal();
            loadScheduleForGroup(currentGroupId);
        } else {
            showError(data.error || '–°–∞–±–∞–∫—Ç—ã ”©—á“Ø—Ä“Ø“Ø–¥”© –∫–∞—Ç–∞ –∫–µ—Ç—Ç–∏');
        }
    })
    .catch(error => {
        console.error('Error deleting lesson:', error);
        showError('–°–∞–±–∞–∫—Ç—ã ”©—á“Ø—Ä“Ø“Ø–¥”© –∫–∞—Ç–∞ –∫–µ—Ç—Ç–∏');
    });
}

// === –ö–ï–õ“Æ“Æ-–ö–ï–¢“Æ“Æ –ú–û–î–ê–õ–´–ù –ê–ß–£–£ ===
function openAttendanceModal(lessonId) {
    if (!userPermissions.can_mark_attendance) {
        showError('–°–∏–∑–¥–µ –∂–æ–∫—Ç–æ–æ –±–µ–ª–≥–∏–ª”©”© —É–∫—É–≥—É –∂–æ–∫');
        return;
    }
    
    currentLessonId = lessonId;
    
    fetch(`{% url 'get_lesson_students' %}?lesson_id=${lessonId}`)
        .then(response => response.json())
        .then(data => {
            if (data.students && data.lesson_info) {
                displayLessonInfo(data.lesson_info);
                displayStudentsList(data.students);
                updateAttendanceSummary();
                document.getElementById('attendanceModal').style.display = 'block';
            } else {
                showError(data.error || '–°—Ç—É–¥–µ–Ω—Ç—Ç–µ—Ä–¥–∏–Ω —Ç–∏–∑–º–µ—Å–∏ –∂“Ø–∫—Ç”©–ª–≥”©–Ω –∂–æ–∫');
            }
        })
        .catch(error => {
            console.error('Error loading students:', error);
            showError('–°—Ç—É–¥–µ–Ω—Ç—Ç–µ—Ä–¥–∏–Ω —Ç–∏–∑–º–µ—Å–∏–Ω –∂“Ø–∫—Ç”©”©–¥”© –∫–∞—Ç–∞ –∫–µ—Ç—Ç–∏');
        });
}

// === –°–ê–ë–ê–ö –ú–ê–ê–õ–´–ú–ê–¢–´–ù –ö”®–†–°”®–¢“Æ“Æ ===
function displayLessonInfo(lessonInfo) {
    const lessonInfoDiv = document.getElementById('lessonInfo');
    lessonInfoDiv.innerHTML = `
        <h3>üìö ${lessonInfo.subject}</h3>
        <p><strong>üë®‚Äçüè´ –ú—É–≥–∞–ª–∏–º:</strong> ${lessonInfo.teacher}</p>
        <p><strong>üìç –ö–∞–±–∏–Ω–µ—Ç:</strong> ${lessonInfo.room}</p>
        <p><strong>‚è∞ –£–±–∞–∫—ã—Ç:</strong> ${lessonInfo.time}</p>
        <p><strong>üìÖ –ö“Ø–Ω:</strong> ${lessonInfo.day}</p>
        <p><strong>üë• –ì—Ä—É–ø–ø–∞:</strong> ${lessonInfo.group}</p>
    `;
}

// === –°–¢–£–î–ï–ù–¢–¢–ï–†–î–ò–ù –¢–ò–ó–ú–ï–°–ò–ù –ö”®–†–°”®–¢“Æ“Æ ===
function displayStudentsList(students) {
    const studentsListDiv = document.getElementById('studentsList');
    studentsListDiv.innerHTML = '';
    
    currentAttendanceData = {};
    
    students.forEach((student, index) => {
        currentAttendanceData[student.id] = student.current_status || 'Present';
        
        const studentDiv = document.createElement('div');
        studentDiv.className = 'student-item';
        studentDiv.innerHTML = `
            <div class="student-name">${index + 1}. ${student.name}</div>
            <div class="attendance-buttons">
                <button class="status-btn present ${student.current_status === 'Present' ? 'active' : ''}" 
                        onclick="setAttendanceStatus(${student.id}, 'Present')">
                    ‚úÖ –ö–µ–ª–¥–∏
                </button>
                <button class="status-btn late ${student.current_status === 'Late' ? 'active' : ''}" 
                        onclick="setAttendanceStatus(${student.id}, 'Late')">
                    ‚è∞ –ö–µ—á–∏–∫—Ç–∏
                </button>
                <button class="status-btn absent ${student.current_status === 'Absent' ? 'active' : ''}" 
                        onclick="setAttendanceStatus(${student.id}, 'Absent')">
                    ‚ùå –ñ–æ–∫
                </button>
            </div>
        `;
        studentsListDiv.appendChild(studentDiv);
    });
}

// === –ö–ï–õ“Æ“Æ-–ö–ï–¢“Æ“Æ –°–¢–ê–¢–£–°–£–ù –ö–û–Æ–£ ===
function setAttendanceStatus(studentId, status) {
    currentAttendanceData[studentId] = status;
    
    // –ë–∞—Å–∫—ã—á—Ç–∞—Ä–¥—ã–Ω –∞–∫—Ç–∏–≤–¥“Ø“Ø –∞–±–∞–ª—ã–Ω –∂–∞“£—ã–ª–æ–æ
    const studentItem = document.querySelector(`[onclick="setAttendanceStatus(${studentId}, 'Present')"]`).closest('.student-item');
    const buttons = studentItem.querySelectorAll('.status-btn');
    
    buttons.forEach(btn => btn.classList.remove('active'));
    studentItem.querySelector(`.status-btn.${status.toLowerCase()}`).classList.add('active');
    
    updateAttendanceSummary();
}

// === –ö–ï–õ“Æ“Æ-–ö–ï–¢“Æ“Æ –ñ–´–ô–´–ù–¢–´–ì–´–ù –ñ–ê“¢–´–õ–û–û ===
function updateAttendanceSummary() {
    let presentCount = 0, absentCount = 0, lateCount = 0;
    
    Object.values(currentAttendanceData).forEach(status => {
        switch(status) {
            case 'Present': presentCount++; break;
            case 'Absent': absentCount++; break;
            case 'Late': lateCount++; break;
        }
    });
    
    document.getElementById('presentCount').textContent = presentCount;
    document.getElementById('absentCount').textContent = absentCount;
    document.getElementById('lateCount').textContent = lateCount;
}

// === –ö–ï–õ“Æ“Æ-–ö–ï–¢“Æ“Æ–ù“Æ –°–ê–ö–¢–û–û ===
function saveAttendance() {
    if (!currentLessonId || Object.keys(currentAttendanceData).length === 0) {
        showError('–ñ–æ–∫—Ç–æ–æ –º–∞–∞–ª—ã–º–∞—Ç—ã –∂–æ–∫');
        return;
    }
    
    fetch('{% url "save_attendance" %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCSRFToken()
        },
        body: JSON.stringify({
            lesson_id: currentLessonId,
            attendance: currentAttendanceData,
            date: new Date().toISOString().split('T')[0]
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showSuccess(data.message);
            closeAttendanceModal();
        } else {
            showError(data.error || '–ñ–æ–∫—Ç–æ–æ–Ω—É —Å–∞–∫—Ç–æ–æ–¥–æ –∫–∞—Ç–∞ –∫–µ—Ç—Ç–∏');
        }
    })
    .catch(error => {
        console.error('Error saving attendance:', error);
        showError('–ñ–æ–∫—Ç–æ–æ–Ω—É —Å–∞–∫—Ç–æ–æ–¥–æ –∫–∞—Ç–∞ –∫–µ—Ç—Ç–∏');
    });
}

// === –ú–û–î–ê–õ–î–ê–†–î–´ –ñ–ê–ë–£–£ ===
function closeLessonModal() {
    document.getElementById('lessonModal').style.display = 'none';
    currentLessonId = null;
}

function closeAttendanceModal() {
    document.getElementById('attendanceModal').style.display = 'none';
    currentLessonId = null;
    currentAttendanceData = {};
}

// === –°–ê–ë–ê–ö –§–û–†–ú–ê–°–´–ù –ñ”®–ù”®–¢“Æ“Æ ===
document.getElementById('lessonForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const subjectId = document.getElementById('subjectSelect').value;
    const teacherId = document.getElementById('teacherSelect').value;
    const room = document.getElementById('roomInput').value;
    const timeSlotId = this.getAttribute('data-time-slot');
    const day = this.getAttribute('data-day');
    
    if (!subjectId || !currentGroupId || !timeSlotId || !day) {
        showError('–¢–∞–ª–∞–ø–∫–∞ —Å–∞–π –±–∞—Ä–¥—ã–∫ –º–∞–∞–ª—ã–º–∞—Ç—Ç—ã —Ç–æ–ª—Ç—É—Ä—É“£—É–∑');
        return;
    }
    
    const requestData = {
        subject_id: subjectId,
        teacher_id: teacherId || null,
        group_id: currentGroupId,
        time_slot_id: timeSlotId,
        day: day,
        room: room
    };
    
    if (currentLessonId) {
        requestData.lesson_id = currentLessonId;
    }
    
    fetch('{% url "save_schedule_lesson" %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCSRFToken()
        },
        body: JSON.stringify(requestData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showSuccess(data.message);
            closeLessonModal();
            loadScheduleForGroup(currentGroupId);
        } else {
            showError(data.error || '–°–∞–±–∞–∫—Ç—ã —Å–∞–∫—Ç–æ–æ–¥–æ –∫–∞—Ç–∞ –∫–µ—Ç—Ç–∏');
        }
    })
    .catch(error => {
        console.error('Error saving lesson:', error);
        showError('–°–∞–±–∞–∫—Ç—ã —Å–∞–∫—Ç–æ–æ–¥–æ –∫–∞—Ç–∞ –∫–µ—Ç—Ç–∏');
    });
});

// === –ú–û–î–ê–õ–î–ê–†–î–´ –¢–´–®–ö–ê–†–´ –ë–ê–°–ö–ê–ù–î–ê –ñ–ê–ë–£–£ ===
window.onclick = function(event) {
    const lessonModal = document.getElementById('lessonModal');
    const attendanceModal = document.getElementById('attendanceModal');
    
    if (event.target === lessonModal) {
        closeLessonModal();
    }
    if (event.target === attendanceModal) {
        closeAttendanceModal();
    }
};

// === HELPER –§–£–ù–ö–¶–ò–Ø–õ–ê–† ===
function getCSRFToken() {
    return document.querySelector('[name=csrfmiddlewaretoken]')?.value || 
           document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') || '';
}

function showSuccess(message) {
    const alert = document.createElement('div');
    alert.className = 'alert alert-success';
    alert.textContent = message;
    alert.style.position = 'fixed';
    alert.style.top = '20px';
    alert.style.right = '20px';
    alert.style.zIndex = '2000';
    alert.style.minWidth = '300px';
    
    document.body.appendChild(alert);
    
    setTimeout(() => {
        if (document.body.contains(alert)) {
            document.body.removeChild(alert);
        }
    }, 5000);
}

function showError(message) {
    const alert = document.createElement('div');
    alert.className = 'alert alert-error';
    alert.textContent = message;
    alert.style.position = 'fixed';
    alert.style.top = '20px';
    alert.style.right = '20px';
    alert.style.zIndex = '2000';
    alert.style.minWidth = '300px';
    
    document.body.appendChild(alert);
    
    setTimeout(() => {
        if (document.body.contains(alert)) {
            document.body.removeChild(alert);
        }
    }, 7000);
}

// === –≠–ú–£–õ–Ø–¶–ò–Ø –§–£–ù–ö–¶–ò–Ø–õ–ê–†–´ (DEVELOPMENT “Ø—á“Ø–Ω) ===
function handleLessonClick(lessonId) {
    // –°–∞–±–∞–∫–∫–∞ –±–∞—Å–∫–∞–Ω–¥–∞ –∞—Ç–∫–∞—Ä—ã–ª–∞—Ç (–∫–æ—à—É–º—á–∞ —Ñ—É–Ω–∫—Ü–∏—è–ª–∞—Ä “Ø—á“Ø–Ω)
    console.log('Lesson clicked:', lessonId);
}

function handleEmptyClick(timeSlotId, day) {
    // –≠—Ä–∫–∏–Ω —É–±–∞–∫—ã—Ç–∫–∞ –±–∞—Å–∫–∞–Ω–¥–∞ –∞—Ç–∫–∞—Ä—ã–ª–∞—Ç
    if (userPermissions.can_edit) {
        addLesson(timeSlotId, day);
    }
}

// === –ê–í–¢–û–ú–ê–¢–¢–´–ö –ñ“Æ–ö–¢”®”® (–°–¢–£–î–ï–ù–¢/–ê–¢–ê-–≠–ù–ï “Æ–ß“Æ–ù) ===
document.addEventListener('DOMContentLoaded', function() {
    console.log('Page loaded, user role:', '{{ user_role }}');
    
    // –≠–≥–µ—Ä —Å—Ç—É–¥–µ–Ω—Ç –∂–µ –∞—Ç–∞-—ç–Ω–µ –±–æ–ª—Å–æ, –∞–≤—Ç–æ–º–∞—Ç—Ç—ã–∫ —Ç“Ø—Ä–¥”© schedule –∂“Ø–∫—Ç”©–±“Ø–∑
    {% if user_role == 'STUDENT' and user_group %}
        console.log('Auto-loading schedule for student group: {{ user_group.id }}');
        loadScheduleForGroup({{ user_group.id }});
    {% elif user_role == 'PARENT' %}
        // –ê—Ç–∞-—ç–Ω–µ–ª–µ—Ä “Ø—á“Ø–Ω –±–∏—Ä–∏–Ω—á–∏ –±–∞–ª–∞–Ω—ã–Ω –≥—Ä—É–ø–ø–∞—Å—ã–Ω –∂“Ø–∫—Ç”©–±“Ø–∑
        console.log('Parent detected, should load child schedules');
    {% else %}
        console.log('Admin/Manager/Teacher - manual selection required');
    {% endif %}
});
</script>
{% endblock %}
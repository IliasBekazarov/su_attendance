{% extends 'base.html' %}

{% block title %}Менин жоктоом{% endblock %}

{% block content %}
<div class="container mt-4">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card bg-gradient-primary text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h2 class="mb-1"><i class="fas fa-clipboard-check me-2"></i>Менин жоктоом</h2>
                            <p class="mb-0">{{ teacher.name }} - Бүгүнкү сабактар</p>
                        </div>
                        <div class="text-end">
                            <div class="badge bg-light text-dark fs-6">
                                <i class="fas fa-calendar me-1"></i>{{ today|date:"d.m.Y" }}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Сабактар тизмеси -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-light">
                    <h5 class="mb-0">
                        <i class="fas fa-list me-2"></i>Менин сабактарым
                    </h5>
                </div>
                <div class="card-body p-0">
                    {% if schedules %}
                        <div class="table-responsive">
                            <table class="table table-hover mb-0">
                                <thead class="table-secondary">
                                    <tr>
                                        <th>Күн</th>
                                        <th>Убакыт</th>
                                        <th>Предмет</th>
                                        <th>Группа</th>
                                        <th>Бөлмө</th>
                                        <th>Студенттер</th>
                                        <th>Статус</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for schedule in schedules %}
                                    <tr class="schedule-row" data-schedule-id="{{ schedule.id }}">
                                        <td class="fw-bold">
                                            {% if schedule.day == 'Monday' %}Дүйшөмбү
                                            {% elif schedule.day == 'Tuesday' %}Шейшемби
                                            {% elif schedule.day == 'Wednesday' %}Шаршемби
                                            {% elif schedule.day == 'Thursday' %}Бейшемби
                                            {% elif schedule.day == 'Friday' %}Жума
                                            {% elif schedule.day == 'Saturday' %}Ишемби
                                            {% else %}{{ schedule.day }}{% endif %}
                                        </td>
                                        <td>
                                            <span class="badge bg-info">
                                                {{ schedule.start_time|time:"H:i" }} - {{ schedule.end_time|time:"H:i" }}
                                            </span>
                                        </td>
                                        <td>
                                            <div class="fw-bold text-primary cursor-pointer" onclick="toggleAttendance({{ schedule.id }})">
                                                {{ schedule.subject.subject_name }}
                                                <i class="fas fa-chevron-down ms-2"></i>
                                            </div>
                                        </td>
                                        <td>
                                            <span class="badge bg-secondary">{{ schedule.group.name }}</span>
                                        </td>
                                        <td>
                                            {% if schedule.room %}
                                                <i class="fas fa-door-open me-1"></i>{{ schedule.room }}
                                            {% else %}
                                                <span class="text-muted">-</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            <span class="badge bg-light text-dark">
                                                {{ schedule.group.student_set.count }} адам
                                            </span>
                                        </td>
                                        <td>
                                            <span class="badge bg-warning">Белгиленген жок</span>
                                        </td>
                                    </tr>
                                    
                                    <!-- Студенттердин тизмеси (жашыруун) -->
                                    <tr id="attendance-{{ schedule.id }}" class="attendance-row" style="display: none;">
                                        <td colspan="7" class="p-0">
                                            <div class="bg-light border-top">
                                                <div class="p-4">
                                                    <div class="d-flex justify-content-between align-items-center mb-3">
                                                        <h6 class="mb-0">
                                                            <i class="fas fa-users me-2"></i>
                                                            {{ schedule.subject.subject_name }} - {{ schedule.group.name }}
                                                        </h6>
                                                        <div class="btn-group" role="group">
                                                            <button type="button" class="btn btn-sm btn-outline-success" onclick="markAll({{ schedule.id }}, 'Present')">
                                                                <i class="fas fa-check me-1"></i>Баары катышты
                                                            </button>
                                                            <button type="button" class="btn btn-sm btn-outline-danger" onclick="markAll({{ schedule.id }}, 'Absent')">
                                                                <i class="fas fa-times me-1"></i>Баары жок
                                                            </button>
                                                            <button type="button" class="btn btn-sm btn-outline-secondary" onclick="clearAll({{ schedule.id }})">
                                                                <i class="fas fa-eraser me-1"></i>Тазалоо
                                                            </button>
                                                        </div>
                                                    </div>
                                                    
                                                    <form method="POST" id="attendance-form-{{ schedule.id }}">
                                                        {% csrf_token %}
                                                        <input type="hidden" name="schedule_id" value="{{ schedule.id }}">
                                                        
                                                        <div class="row">
                                                            {% for student in schedule.group.student_set.all %}
                                                            <div class="col-md-6 mb-3">
                                                                <div class="card border-light">
                                                                    <div class="card-body p-3">
                                                                        <div class="d-flex align-items-center mb-2">
                                                                            <div class="bg-primary rounded-circle text-white d-flex align-items-center justify-content-center me-3" 
                                                                                 style="width: 35px; height: 35px; font-size: 14px;">
                                                                                {{ student.name|first|upper }}
                                                                            </div>
                                                                            <div class="fw-bold">{{ student.name }}</div>
                                                                        </div>
                                                                        
                                                                        <div class="d-flex gap-2">
                                                                            <div class="form-check form-check-inline">
                                                                                <input type="radio" name="status_{{ student.id }}" value="Present" 
                                                                                       class="form-check-input" id="present_{{ schedule.id }}_{{ student.id }}">
                                                                                <label class="form-check-label text-success small fw-bold" 
                                                                                       for="present_{{ schedule.id }}_{{ student.id }}">
                                                                                    <i class="fas fa-check"></i> Бар
                                                                                </label>
                                                                            </div>
                                                                            <div class="form-check form-check-inline">
                                                                                <input type="radio" name="status_{{ student.id }}" value="Absent" 
                                                                                       class="form-check-input" id="absent_{{ schedule.id }}_{{ student.id }}">
                                                                                <label class="form-check-label text-danger small fw-bold" 
                                                                                       for="absent_{{ schedule.id }}_{{ student.id }}">
                                                                                    <i class="fas fa-times"></i> Жок
                                                                                </label>
                                                                            </div>
                                                                            <div class="form-check form-check-inline">
                                                                                <input type="radio" name="status_{{ student.id }}" value="Late" 
                                                                                       class="form-check-input" id="late_{{ schedule.id }}_{{ student.id }}">
                                                                                <label class="form-check-label text-warning small fw-bold" 
                                                                                       for="late_{{ schedule.id }}_{{ student.id }}">
                                                                                    <i class="fas fa-clock"></i> Кеч
                                                                                </label>
                                                                            </div>
                                                                        </div>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                            {% endfor %}
                                                        </div>
                                                        
                                                        <div class="text-center mt-4">
                                                            <button type="submit" class="btn btn-success btn-lg">
                                                                <i class="fas fa-save me-2"></i>Жоктооду сактоо
                                                            </button>
                                                        </div>
                                                    </form>
                                                </div>
                                            </div>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    {% else %}
                        <div class="text-center py-5">
                            <i class="fas fa-calendar-times fa-3x text-muted mb-3"></i>
                            <h5 class="text-muted">Сизге берилген сабактар жок</h5>
                            <p class="text-muted">Администратор менен байланышыңыз</p>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Статистика -->
    <div class="row mt-4">
        <div class="col-md-3">
            <div class="card text-center border-primary">
                <div class="card-body">
                    <h4 class="text-primary">{{ schedules.count }}</h4>
                    <p class="mb-0">Менин сабактарым</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center border-success">
                <div class="card-body">
                    <h4 class="text-success">{{ total_students }}</h4>
                    <p class="mb-0">Студенттер</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center border-info">
                <div class="card-body">
                    <h4 class="text-info">{{ unique_groups }}</h4>
                    <p class="mb-0">Группалар</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center border-warning">
                <div class="card-body">
                    <h4 class="text-warning">{{ subjects.count }}</h4>
                    <p class="mb-0">Предметтер</p>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.cursor-pointer {
    cursor: pointer;
}
.schedule-row:hover {
    background-color: #f8f9fa;
}
.bg-gradient-primary {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
}
.attendance-row {
    background-color: #f8f9fa;
}
</style>

<script>
function toggleAttendance(scheduleId) {
    const row = document.getElementById('attendance-' + scheduleId);
    const icon = document.querySelector('[onclick="toggleAttendance(' + scheduleId + ')"] i');
    
    if (row.style.display === 'none' || row.style.display === '') {
        row.style.display = 'table-row';
        if (icon) {
            icon.classList.remove('fa-chevron-down');
            icon.classList.add('fa-chevron-up');
        }
    } else {
        row.style.display = 'none';
        if (icon) {
            icon.classList.remove('fa-chevron-up');
            icon.classList.add('fa-chevron-down');
        }
    }
}

function markAll(scheduleId, status) {
    const form = document.getElementById('attendance-form-' + scheduleId);
    if (form) {
        const radios = form.querySelectorAll('input[value="' + status + '"]');
        radios.forEach(radio => {
            radio.checked = true;
        });
    }
}

function clearAll(scheduleId) {
    const form = document.getElementById('attendance-form-' + scheduleId);
    if (form) {
        const radios = form.querySelectorAll('input[type="radio"]');
        radios.forEach(radio => {
            radio.checked = false;
        });
    }
}

// Form submit учурунда confirmation
document.addEventListener('DOMContentLoaded', function() {
    const forms = document.querySelectorAll('form[id^="attendance-form-"]');
    forms.forEach(form => {
        form.addEventListener('submit', function(e) {
            const checkedRadios = form.querySelectorAll('input[type="radio"]:checked');
            if (checkedRadios.length === 0) {
                e.preventDefault();
                alert('Эч бир студенттин статусу белгиленген жок!');
                return false;
            }
            
            if (!confirm('Жоктооду сактагыңыз келеби?')) {
                e.preventDefault();
                return false;
            }
        });
    });
});
</script>
{% endblock %}

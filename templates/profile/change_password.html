{% extends 'base.html' %}
{% load static %}

{% block title %}Сыр сөздү өзгөртүү{% endblock %}

{% block extra_css %}
<style>
.password-card {
    border: none;
    border-radius: 15px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    max-width: 500px;
    margin: 2rem auto;
}

.card-header {
    background: linear-gradient(135deg, #dc3545, #bd2130);
    color: white;
    border-radius: 15px 15px 0 0 !important;
    text-align: center;
}

.password-icon {
    width: 80px;
    height: 80px;
    background: rgba(255,255,255,0.2);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    margin: 0 auto 1rem auto;
    font-size: 2rem;
}

.form-control:focus {
    border-color: #dc3545;
    box-shadow: 0 0 0 0.2rem rgba(220, 53, 69, 0.25);
}

.btn-change-password {
    background: linear-gradient(135deg, #dc3545, #bd2130);
    border: none;
    border-radius: 25px;
    padding: 0.75rem 2rem;
    font-weight: 600;
    color: white;
    width: 100%;
    transition: all 0.3s ease;
}

.btn-change-password:hover {
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(220, 53, 69, 0.3);
    color: white;
}

.btn-cancel {
    background: #6c757d;
    border: none;
    border-radius: 25px;
    padding: 0.75rem 2rem;
    font-weight: 600;
    color: white;
    width: 100%;
}

.btn-cancel:hover {
    background: #5a6268;
    color: white;
}

.password-strength {
    height: 5px;
    border-radius: 3px;
    margin-top: 0.5rem;
    transition: all 0.3s ease;
}

.strength-weak { background: #dc3545; }
.strength-medium { background: #ffc107; }
.strength-strong { background: #28a745; }

.security-tips {
    background: #f8f9fa;
    border-radius: 10px;
    padding: 1rem;
    border-left: 4px solid #17a2b8;
}

.security-tips h6 {
    color: #17a2b8;
    margin-bottom: 0.5rem;
}

.security-tips ul {
    font-size: 0.9rem;
    color: #6c757d;
    margin-bottom: 0;
}

.form-group {
    position: relative;
    margin-bottom: 1.5rem;
}

.password-toggle {
    position: absolute;
    right: 10px;
    top: 50%;
    transform: translateY(-50%);
    cursor: pointer;
    color: #6c757d;
    z-index: 10;
}

.password-toggle:hover {
    color: #495057;
}
</style>
{% endblock %}

{% block content %}
<div class="container py-4">
    <div class="card password-card">
        <div class="card-header py-4">
            <div class="password-icon">
                <i class="fas fa-lock"></i>
            </div>
            <h4 class="mb-0">Сыр сөздү өзгөртүү</h4>
            <small>Коопсуздук үчүн сыр сөзүңүздү мезгил-мезгили менен өзгөртүңүз</small>
        </div>
        
        <div class="card-body p-4">
            <form method="post" id="passwordForm">
                {% csrf_token %}
                
                <!-- Азыркы сыр сөз -->
                <div class="form-group">
                    <label for="{{ form.old_password.id_for_label }}" class="form-label">
                        <i class="fas fa-key me-2"></i>{{ form.old_password.label }}
                    </label>
                    <div class="position-relative">
                        {{ form.old_password }}
                        <i class="fas fa-eye password-toggle" onclick="togglePassword('{{ form.old_password.id_for_label }}', this)"></i>
                    </div>
                    {% if form.old_password.errors %}
                        <div class="text-danger mt-1">
                            {% for error in form.old_password.errors %}
                                <small>{{ error }}</small>
                            {% endfor %}
                        </div>
                    {% endif %}
                </div>

                <!-- Жаңы сыр сөз -->
                <div class="form-group">
                    <label for="{{ form.new_password1.id_for_label }}" class="form-label">
                        <i class="fas fa-lock me-2"></i>{{ form.new_password1.label }}
                    </label>
                    <div class="position-relative">
                        {{ form.new_password1 }}
                        <i class="fas fa-eye password-toggle" onclick="togglePassword('{{ form.new_password1.id_for_label }}', this)"></i>
                    </div>
                    <div class="password-strength" id="password-strength"></div>
                    {% if form.new_password1.errors %}
                        <div class="text-danger mt-1">
                            {% for error in form.new_password1.errors %}
                                <small>{{ error }}</small>
                            {% endfor %}
                        </div>
                    {% endif %}
                </div>

                <!-- Жаңы сыр сөздү кайталоо -->
                <div class="form-group">
                    <label for="{{ form.new_password2.id_for_label }}" class="form-label">
                        <i class="fas fa-check-double me-2"></i>{{ form.new_password2.label }}
                    </label>
                    <div class="position-relative">
                        {{ form.new_password2 }}
                        <i class="fas fa-eye password-toggle" onclick="togglePassword('{{ form.new_password2.id_for_label }}', this)"></i>
                    </div>
                    <div id="password-match-indicator" class="mt-1"></div>
                    {% if form.new_password2.errors %}
                        <div class="text-danger mt-1">
                            {% for error in form.new_password2.errors %}
                                <small>{{ error }}</small>
                            {% endfor %}
                        </div>
                    {% endif %}
                </div>

                <!-- Non-field errors -->
                {% if form.non_field_errors %}
                    <div class="alert alert-danger">
                        {% for error in form.non_field_errors %}
                            {{ error }}
                        {% endfor %}
                    </div>
                {% endif %}

                <!-- Security Tips -->
                <div class="security-tips mb-4">
                    <h6><i class="fas fa-shield-alt me-2"></i>Коопсуз сыр сөз үчүн кеңештер:</h6>
                    <ul class="ps-3 mb-0">
                        <li>Жок дегенде 8 символ колдонуңуз</li>
                        <li>Чоң жана кичине тамгаларды аралаштырыңыз</li>
                        <li>Сандарды жана атайын символдорду кошуңуз (@, #, !, ж.б.)</li>
                        <li>Жеңил табылуучу сөздөрдү колдонбоңуз</li>
                        <li>Башка сайттардагы сыр сөзүңүздү колдонбоңуз</li>
                    </ul>
                </div>

                <!-- Buttons -->
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <button type="submit" class="btn btn-change-password">
                            <i class="fas fa-save me-2"></i>Сыр сөздү өзгөртүү
                        </button>
                    </div>
                    <div class="col-md-6 mb-3">
                        <a href="{% url 'profile_view' %}" class="btn btn-cancel">
                            <i class="fas fa-times me-2"></i>Жокко чыгаруу
                        </a>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
function togglePassword(inputId, icon) {
    const input = document.getElementById(inputId);
    if (input.type === 'password') {
        input.type = 'text';
        icon.classList.remove('fa-eye');
        icon.classList.add('fa-eye-slash');
    } else {
        input.type = 'password';
        icon.classList.remove('fa-eye-slash');
        icon.classList.add('fa-eye');
    }
}

function checkPasswordStrength(password) {
    let strength = 0;
    
    if (password.length >= 8) strength += 1;
    if (password.match(/[a-z]/)) strength += 1;
    if (password.match(/[A-Z]/)) strength += 1;
    if (password.match(/[0-9]/)) strength += 1;
    if (password.match(/[^a-zA-Z0-9]/)) strength += 1;
    
    return strength;
}

function updatePasswordStrength(password) {
    const strengthBar = document.getElementById('password-strength');
    const strength = checkPasswordStrength(password);
    
    strengthBar.style.width = '100%';
    
    if (strength < 2) {
        strengthBar.className = 'password-strength strength-weak';
    } else if (strength < 4) {
        strengthBar.className = 'password-strength strength-medium';
    } else {
        strengthBar.className = 'password-strength strength-strong';
    }
}

function checkPasswordMatch() {
    const password1 = document.getElementById('{{ form.new_password1.id_for_label }}').value;
    const password2 = document.getElementById('{{ form.new_password2.id_for_label }}').value;
    const indicator = document.getElementById('password-match-indicator');
    
    if (password2 && password1 !== password2) {
        indicator.innerHTML = '<small class="text-danger"><i class="fas fa-times me-1"></i>Сыр сөздөр дал келген жок</small>';
    } else if (password2 && password1 === password2) {
        indicator.innerHTML = '<small class="text-success"><i class="fas fa-check me-1"></i>Сыр сөздөр дал келди</small>';
    } else {
        indicator.innerHTML = '';
    }
}

$(document).ready(function() {
    $('#{{ form.new_password1.id_for_label }}').on('input', function() {
        updatePasswordStrength(this.value);
    });
    
    $('#{{ form.new_password2.id_for_label }}').on('input', function() {
        checkPasswordMatch();
    });
    
    $('#{{ form.new_password1.id_for_label }}').on('input', function() {
        checkPasswordMatch();
    });
    
    // Form validation
    $('#passwordForm').submit(function(e) {
        const password1 = $('#{{ form.new_password1.id_for_label }}').val();
        const password2 = $('#{{ form.new_password2.id_for_label }}').val();
        
        if (password1.length < 8) {
            e.preventDefault();
            alert('Сыр сөз жок дегенде 8 символдан турушу керек!');
            return false;
        }
        
        if (password1 !== password2) {
            e.preventDefault();
            alert('Сыр сөздөр дал келген жок!');
            return false;
        }
        
        if (confirm('Сыр сөзүңүздү чын эле өзгөртүүнү каалайсызбы? Андан кийин кайрадан кирүүгө туура келет.')) {
            return true;
        } else {
            e.preventDefault();
            return false;
        }
    });
});
</script>
{% endblock %}
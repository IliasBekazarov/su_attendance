{% extends 'base.html' %}
{% load django_bootstrap5 %}
{% block title %}{{ user.get_full_name|default:user.username }} - Башкаруу Панели{% endblock %}

{% block content %}
<div class="container mt-4">
    <!-- Колдонуучу маалыматтары -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card bg-primary text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h2 class="mb-1">{{ user.get_full_name|default:user.username }}</h2>
                            <p class="mb-0">
                                {% if role == 'ADMIN' %}
                                    <i class="fas fa-crown me-2"></i>Система Администратору
                                {% elif role == 'MANAGER' %}
                                    <i class="fas fa-clipboard-list me-2"></i>Менеджер
                                {% elif role == 'TEACHER' %}
                                    <i class="fas fa-chalkboard-teacher me-2"></i>Мугалим
                                    {% if teacher_obj %}
                                        - {{ teacher_obj.name }}
                                    {% endif %}
                                {% elif role == 'STUDENT' %}
                                    <i class="fas fa-user-graduate me-2"></i>Студент
                                    {% if student_obj %}
                                        - {{ student_obj.name }} ({{ student_obj.group.name }})
                                    {% endif %}
                                {% elif role == 'PARENT' %}
                                    <i class="fas fa-heart me-2"></i>Ата-эне
                                {% endif %}
                            </p>
                        </div>
                        <div class="text-end">
                            <div class="badge bg-light text-dark fs-6">
                                <i class="fas fa-calendar-alt me-1"></i>
                                {{ today|date:"d F Y" }}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% if role == 'STUDENT' or role == 'PARENT' %}
    <form method="GET" class="mb-4">
        <div class="row g-3">
            <div class="col-md-4">
                <label class="form-label">Башталыш датасы:</label>
                <input type="date" name="start_date" value="{{ start_date }}" class="form-control">
            </div>
            <div class="col-md-4">
                <label class="form-label">Аяктоо датасы:</label>
                <input type="date" name="end_date" value="{{ end_date }}" class="form-control">
            </div>
            <div class="col-md-4 d-flex align-items-end">
                {% bootstrap_button "Чыпкалоо" button_type="submit" button_class="btn-primary w-100" %}
            </div>
        </div>
    </form>
    {% endif %}

    {% if role == 'ADMIN' or role == 'MANAGER' %}
    <div class="row g-4 mb-4">
        <!-- Статистика карточкалары -->
        <div class="col-md-3">
            <div class="card shadow-sm border-0">
                <div class="card-body text-center">
                    <div class="mb-3">
                        <i class="fas fa-users fa-2x text-primary"></i>
                    </div>
                    <h3 class="mb-1">{{ total_students }}</h3>
                    <p class="text-muted mb-0">Студенттер</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card shadow-sm border-0">
                <div class="card-body text-center">
                    <div class="mb-3">
                        <i class="fas fa-chalkboard-teacher fa-2x text-success"></i>
                    </div>
                    <h3 class="mb-1">{{ total_teachers }}</h3>
                    <p class="text-muted mb-0">Мугалимдер</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card shadow-sm border-0">
                <div class="card-body text-center">
                    <div class="mb-3">
                        <i class="fas fa-layer-group fa-2x text-info"></i>
                    </div>
                    <h3 class="mb-1">{{ total_groups }}</h3>
                    <p class="text-muted mb-0">Топтор</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card shadow-sm border-0">
                <div class="card-body text-center">
                    <div class="mb-3">
                        <i class="fas fa-book-open fa-2x text-warning"></i>
                    </div>
                    <h3 class="mb-1">{{ total_subjects }}</h3>
                    <p class="text-muted mb-0">Предметтер</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Тез иш-аракеттер -->
    <div class="row g-4 mb-4">
        <div class="col-md-6">
            <div class="card h-100">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="fas fa-cogs me-2"></i>Тез Иш-аракеттер</h5>
                </div>
                <div class="card-body">
                    <div class="d-grid gap-2">
                        <a href="{% url 'mark_attendance' %}" class="btn btn-outline-primary">
                            <i class="fas fa-check-square me-2"></i>Катышууну Белгилөө
                        </a>
                        <a href="{% url 'report' %}" class="btn btn-outline-success">
                            <i class="fas fa-chart-bar me-2"></i>Отчеттор көрүү
                        </a>
                        <a href="{% url 'schedule' %}" class="btn btn-outline-info">
                            <i class="fas fa-calendar-alt me-2"></i>Расписание башкаруу
                        </a>
                        {% if role == 'ADMIN' %}
                        <a href="/admin/" class="btn btn-outline-danger" target="_blank">
                            <i class="fas fa-tools me-2"></i>Админ панель
                        </a>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-md-6">
            <div class="card h-100">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0"><i class="fas fa-bell me-2"></i>Соңку Иш-аракеттер</h5>
                </div>
                <div class="card-body">
                    {% if recent_activities %}
                        <div class="list-group list-group-flush">
                            {% for activity in recent_activities %}
                            <div class="list-group-item border-0 px-0 py-2">
                                <div class="d-flex justify-content-between align-items-start">
                                    <div class="ms-2 me-auto">
                                        <div class="fw-bold">{{ activity.title }}</div>
                                        <small class="text-muted">{{ activity.description }}</small>
                                    </div>
                                    <span class="badge bg-primary rounded-pill">
                                        {{ activity.timestamp|date:"H:i" }}
                                    </span>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    {% else %}
                        <p class="text-muted">Соңку иш-аракеттер жок</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    {% endif %}
    </div>
    {% elif role == 'TEACHER' %}
    <h3 class="mb-4">Сиздин билдирүүлөрүңүз</h3>
    <div class="table-responsive">
        <table class="table table-hover">
            <thead class="table-primary">
                <tr>
                    <th>Студент</th>
                    <th>Билдирүү</th>
                    <th>Дата</th>
                    <th>Окулду</th>
                </tr>
            </thead>
            <tbody>
                {% for notification in notifications %}
                <tr>
                    <td>{{ notification.student.name }}</td>
                    <td>{{ notification.message }}</td>
                    <td>{{ notification.created_at|date:"Y-m-d H:i" }}</td>
                    <td>{{ notification.is_read|yesno:"Ооба,Жок" }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% elif role == 'STUDENT' %}
    <h3 class="mb-4">Сиздин Катышууңуз</h3>
    <div class="row g-4 mb-4">
        <div class="col-md-6">
            <div class="card shadow-sm">
                <div class="card-body">
                    <h5>Катышуу пайызы</h5>
                    <p class="display-6">{{ percentage }}%</p>
                    <div class="progress" style="height: 20px;">
                        <div class="progress-bar bg-success" style="width: {{ percentage }}%"></div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <canvas id="attendanceChart{{ student.id }}" style="max-height: 200px;"></canvas>
            <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
            <script>
                const ctx{{ student.id }} = document.getElementById('attendanceChart{{ student.id }}').getContext('2d');
                new Chart(ctx{{ student.id }}, {
                    type: 'pie',
                    data: {
                        labels: ['Катышты', 'Катышкан жок', 'Кечикти'],
                        datasets: [{
                            data: [{{ present_count }}, {{ absent_count }}, {{ late_count }}],
                            backgroundColor: ['#28a745', '#dc3545', '#ffc107']
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: { position: 'top' },
                            title: { display: true, text: '{{ student.name }} - Катышуу Статистикасы' }
                        }
                    }
                });
            </script>
        </div>
    </div>
    <div class="table-responsive">
        <table class="table table-hover">
            <thead class="table-primary">
                <tr>
                    <th>Сабак</th>
                    <th>Дата</th>
                    <th>Статус</th>
                </tr>
            </thead>
            <tbody>
                {% for att in attendance %}
                <tr>
                    <td>{{ att.subject.subject_name }}</td>
                    <td>{{ att.date }}</td>
                    <td>
                        <span class="badge {% if att.status == 'Present' %}bg-success{% elif att.status == 'Absent' %}bg-danger{% else %}bg-warning{% endif %}">
                            {{ att.status }}
                        </span>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% elif role == 'PARENT' %}
    {% if students_data %}
    {% for data in students_data %}
    <h3 class="mb-4">Балаңыздын Катышуусу: {{ data.student.name }}</h3>
    <div class="row g-4 mb-4">
        <div class="col-md-6">
            <div class="card shadow-sm">
                <div class="card-body">
                    <h5>Катышуу пайызы</h5>
                    <p class="display-6">{{ data.percentage }}%</p>
                    <div class="progress" style="height: 20px;">
                        <div class="progress-bar bg-success" style="width: {{ data.percentage }}%"></div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <canvas id="attendanceChart{{ data.student.id }}" style="max-height: 200px;"></canvas>
            <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
            <script>
                const ctx{{ data.student.id }} = document.getElementById('attendanceChart{{ data.student.id }}').getContext('2d');
                new Chart(ctx{{ data.student.id }}, {
                    type: 'pie',
                    data: {
                        labels: ['Катышты', 'Катышкан жок', 'Кечикти'],
                        datasets: [{
                            data: [{{ data.present_count }}, {{ data.absent_count }}, {{ data.late_count }}],
                            backgroundColor: ['#28a745', '#dc3545', '#ffc107']
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: { position: 'top' },
                            title: { display: true, text: '{{ data.student.name }} - Катышуу Статистикасы' }
                        }
                    }
                });
            </script>
        </div>
    </div>
    <div class="table-responsive">
        <table class="table table-hover">
            <thead class="table-primary">
                <tr>
                    <th>Сабак</th>
                    <th>Дата</th>
                    <th>Статус</th>
                </tr>
            </thead>
            <tbody>
                {% for att in data.attendance %}
                <tr>
                    <td>{{ att.subject.subject_name }}</td>
                    <td>{{ att.date }}</td>
                    <td>
                        <span class="badge {% if att.status == 'Present' %}bg-success{% elif att.status == 'Absent' %}bg-danger{% else %}bg-warning{% endif %}">
                            {{ att.status }}
                        </span>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    <h4 class="mt-4">Мугалимдерден билдирүүлөр</h4>
    <div class="table-responsive">
        <table class="table table-hover">
            <thead class="table-primary">
                <tr>
                    <th>Мугалим</th>
                    <th>Билдирүү</th>
                    <th>Дата</th>
                    <th>Окулду</th>
                </tr>
            </thead>
            <tbody>
                {% for notification in data.notifications %}
                <tr>
                    <td>{{ notification.teacher.name }}</td>
                    <td>{{ notification.message }}</td>
                    <td>{{ notification.created_at|date:"Y-m-d H:i" }}</td>
                    <td>{{ notification.is_read|yesno:"Ооба,Жок" }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% endfor %}
    {% else %}
    <div class="alert alert-warning">Баланын маалыматы жок</div>
    {% endif %}
    {% endif %}
</div>
{% endblock %}